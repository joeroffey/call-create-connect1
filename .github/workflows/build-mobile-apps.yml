name: 📱 Build Mobile Apps (APK & IPA)

on:
  workflow_dispatch: # Allow manual triggers
    inputs:
      build_android:
        description: 'Build Android APK'
        required: false
        default: true
        type: boolean
      build_ios:
        description: 'Build iOS IPA'
        required: false
        default: true
        type: boolean
      build_type:
        description: 'Build Type'
        required: true
        default: 'debug'
        type: choice
        options:
        - debug
        - release
  push:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - 'docs/**'

env:
  NODE_VERSION: '18'
  JAVA_VERSION: '17'

jobs:
  build-android:
    if: ${{ github.event.inputs.build_android != 'false' }}
    name: 🤖 Build Android APK
    runs-on: ubuntu-latest
    
    steps:
    - name: 📥 Checkout Repository
      uses: actions/checkout@v4
      
    - name: ☕ Setup Java JDK
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: ${{ env.JAVA_VERSION }}
        
    - name: 🔧 Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: 📦 Install Dependencies
      run: npm ci
      
    - name: 🏗️ Build Web App
      run: npm run build
      
    - name: 📱 Setup Capacitor
      run: |
        npm install -g @capacitor/cli
        npx cap sync android
        
    - name: 🤖 Setup Android SDK
      uses: android-actions/setup-android@v3
      
    - name: 📋 Create local.properties
      run: |
        echo "sdk.dir=$ANDROID_HOME" > android/local.properties
        
    - name: 🔨 Build Android APK
      run: |
        cd android
        chmod +x ./gradlew
        if [ "${{ github.event.inputs.build_type }}" = "release" ]; then
          ./gradlew assembleRelease
        else
          ./gradlew assembleDebug
        fi
        
    - name: 📋 List APK Files
      run: |
        echo "🔍 Generated APK files:"
        find android -name "*.apk" -type f | while read file; do
          echo "📱 $file ($(du -h "$file" | cut -f1))"
        done
        
    - name: 📤 Upload APK Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: android-apk-${{ github.event.inputs.build_type || 'debug' }}
        path: |
          android/app/build/outputs/apk/**/*.apk
        retention-days: 30
        
    - name: 📊 APK Build Summary
      run: |
        echo "✅ Android APK Build Complete!"
        echo "📱 Build Type: ${{ github.event.inputs.build_type || 'debug' }}"
        echo "📦 APK files are available in the artifacts section"
        echo "🔗 Download from: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

  build-ios:
    if: ${{ github.event.inputs.build_ios != 'false' }}
    name: 🍎 Build iOS IPA
    runs-on: macos-latest
    
    steps:
    - name: 📥 Checkout Repository
      uses: actions/checkout@v4
      
    - name: 🔧 Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: 🍎 Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
        
    - name: 📦 Install Dependencies
      run: npm ci
      
    - name: 🏗️ Build Web App
      run: npm run build
      
    - name: 📱 Setup Capacitor
      run: |
        npm install -g @capacitor/cli
        npx cap sync ios
        
    - name: 🔨 Build iOS App
      run: |
        cd ios
🚀 Quick Solution: Add These Workflows Manually
The workflows are ready but can't be pushed due to large build files blocking Git. Here's how to add them manually to GitHub:

📱 Step 1: Add Quick Test Build Workflow
Go to: https://github.com/joeroffey/call-create-connect1
Navigate to .github/workflows/ folder
Click "Add file" → "Create new file"
Name it: quick-test-build.yml
Copy and paste this complete content:
name: 🚀 Quick Test Build (Android APK)

on:
  workflow_dispatch: # Manual trigger only
    inputs:
      device_type:
        description: 'Target Device'
        required: true
        default: 'phone'
        type: choice
        options:
        - phone
        - tablet
        - both

jobs:
  quick-android-build:
    name: 🚀 Quick Android Test Build
    runs-on: ubuntu-latest
    
    steps:
    - name: 📥 Checkout Code
      uses: actions/checkout@v4
      
    - name: ☕ Setup Java 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        
    - name: 🔧 Setup Node.js 18
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: 📦 Install Dependencies
      run: |
        echo "📦 Installing npm dependencies..."
        npm ci
        
    - name: 🏗️ Build Web App
      run: |
        echo "🏗️ Building React app..."
        npm run build
        
    - name: 📱 Setup Capacitor & Android
      run: |
        echo "📱 Setting up Capacitor..."
        npm install -g @capacitor/cli
        npx cap sync android
        
    - name: 🤖 Setup Android SDK
      uses: android-actions/setup-android@v3
      
    - name: 📋 Configure Android Build
      run: |
        echo "📋 Configuring Android build environment..."
        echo "sdk.dir=$ANDROID_HOME" > android/local.properties
        cd android
        chmod +x ./gradlew
        
    - name: 🔨 Build Debug APK
      run: |
        echo "🔨 Building Android APK..."
        cd android
        ./gradlew assembleDebug --no-daemon --stacktrace
        
    - name: 📋 APK Info
      run: |
        echo "📋 APK Build Information:"
        APK_FILE=$(find android -name "*debug*.apk" -type f | head -1)
        if [ -f "$APK_FILE" ]; then
          echo "✅ APK Built Successfully!"
          echo "📱 File: $APK_FILE"
          echo "📦 Size: $(du -h "$APK_FILE" | cut -f1)"
          echo "🔍 APK Details:"
          ls -la "$APK_FILE"
        else
          echo "❌ APK not found!"
          find android -name "*.apk" -type f
        fi
        
    - name: 📤 Upload APK for Download
      uses: actions/upload-artifact@v4
      with:
        name: EezyBuild-Android-Test-APK
        path: android/app/build/outputs/apk/debug/*.apk
        retention-days: 7
        
    - name: 🎉 Success Summary
      run: |
        echo "🎉 SUCCESS! Your EezyBuild Android APK is ready!"
        echo ""
        echo "📱 What you get:"
        echo "• Installable APK file"
        echo "• All 15 native Capacitor plugins"
        echo "• Camera, file system, sharing features"
        echo "• Push notifications, haptic feedback"
        echo "• Native Android Material Design"
        echo ""
        echo "📦 Download Instructions:"
        echo "1. Go to: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        echo "2. Scroll down to 'Artifacts' section"
        echo "3. Click 'EezyBuild-Android-Test-APK' to download"
        echo "4. Unzip and install the APK on your Android device"
        echo ""
        echo "📱 Installation:"
        echo "• Enable 'Unknown Sources' in Android settings"
        echo "• Transfer APK to your device"
        echo "• Tap the APK file to install"
        echo "• Grant permissions when prompted to test native features"
